"use strict";var pmpApp=angular.module("pmpApp",["ngAnimate","ngRoute","ui.bootstrap","pmpCharts","customFilters","customTags"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"partials/index.html",controller:"IndexController"}).when("/chains",{templateUrl:"partials/chains.html",controller:"ChainsController"}).when("/historical",{templateUrl:"partials/historical.html",controller:"HistoricalController"}).when("/performance",{templateUrl:"partials/performance.html",controller:"PerformanceController"}).when("/present",{templateUrl:"partials/present.html",controller:"PresentController"}),b.html5Mode(!0)}]);pmpApp.controller("MainController",["$location","$route","$rootScope","$interval","$scope","$timeout",function(a,b,c,d,e,f){c.showView=!1,c.searchPanelTemplate="partials/search.html",c.sharePanelTemplate="partials/share.html",c.advancedPanelTemplate="partials/advanced.html",c.filterPanelTemplate="partials/filter.html",e.nav=function(b){""==b?e.showView=!0:e.showView=!1,e.showView||f(function(){a.search({}),a.path(b),f(function(){e.showView=!e.showView,e.nav("")},100)},1100)};var g=a.path;a.path=function(d,e){if(e===!1)var f=b.current,h=c.$on("$locationChangeSuccess",function(){b.current=f,h()});return g.apply(a,[d])},e.showPopUp=function(a,b){switch(a){case"error":e.popUp={show:!0,title:"Error",message:b,style:"panel-danger",icon:"fa-frown-o"},f(function(){e.showPopUp("","")},2e3);break;case"warning":e.popUp={show:!0,title:"Warning",message:b,style:"panel-warning",icon:"fa-exclamation-triangle"},f(function(){e.showPopUp("","")},2e3);break;case"success":e.popUp={show:!0,title:"Success",message:b,style:"panel-success",icon:"fa-check"},f(function(){e.showPopUp("","")},2e3);break;default:e.popUp.show=!1}},e.isEmpty=function(a){return angular.equals({},a)},e.updateDate=function(){e.dt=new Date},f(function(){e.nav("")},100),d(e.updateDate,1e3)}]),pmpApp.controller("PresentController",["$http","$location","$interval","$q","$rootScope","$scope","$timeout",function(a,b,c,d,e,f,g){f.graphType=1,f.allRequestData=[],f.cachedRequestData=[],f.graphParam=["selections","grouping","stacking","coloring"],f.graphTabs=["member_of_campaign","total_events","status","prepid","priority","pwg"],f.inputTags=[],f.initPresent=function(){if(f.aOptionsValues=[1,0,3,0,0,0],f.aRadioValues=[0,0],void 0!=b.search().p){var a=b.search().p.split(",");f.aOptionsValues=a.slice(0,6),f.aRadioValues=a.slice(6,8)}f.requests.selections=[];for(var c=[],d=[],e="",g=0;g<f.aOptionsValues.length;g++)0==f.aOptionsValues[g]?f.requests.selections.push(f.graphTabs[g]):1==f.aOptionsValues[g]?c.push(f.graphTabs[g]):2==f.aOptionsValues[g]?d.push(f.graphTabs[g]):3==f.aOptionsValues[g]&&(e=f.graphTabs[g]);if(f.requests.options={grouping:c,stacking:d,coloring:e},f.requests.radio={},f.requests.radio.scale=["linear","log"],f.requests.radio.mode=["events","requests","seconds"],1==f.aRadioValues[1]&&(f.requests.radio.scale=["log","linear"]),1==f.aRadioValues[0]&&(f.requests.radio.mode=["requests","events","seconds"]),2==f.aRadioValues[0]&&(f.requests.radio.mode=["seconds","events","requests"]),f.showDate="true"===b.search().t,f.growingMode="true"===b.search().m,f.modeUpdate(!0),f.filterPriority=["",""],void 0!=b.search().x){var h=b.search().x.split(",");f.filterPriority=h}var h="";void 0!=b.search().s&&(h=b.search().s),f.updateStatus([],!0,!0,h);var h="";if(void 0!=b.search().w&&(h=b.search().w),f.updatePWG([],!0,!0,h),void 0!=b.search().r){f.loadingData=!0;for(var h=b.search().r.split(","),g=0;g<h.length;g++)f.load(h[g],!0,h.length)}else f.url=b.absUrl()},f.updateStatus=function(a,b,c,d){if(b&&(f.allStatus={}),void 0!==d)for(var e=d.split(","),g=0;g<e.length;g++)""!=e[g]&&(f.allStatus[e[g]]=c);for(var g=0;g<a.length;g++){var h=a[g].status;void 0===f.allStatus[h]&&(f.allStatus[h]=c)}},f.load=function(b,c,d){if(b)if(c&-1!==f.inputTags.indexOf(b))f.showPopUp("warning","Your request is already loaded");else{if(f.loadingData=!0,f.growingMode)var e=a.get("api/"+b+"/growing");else var e=a.get("api/"+b+"/announced");e.then(function(a){if(a.data.results.length){if(f.allRequestData=[],c?(a.data.results.push.apply(a.data.results,f.cachedRequestData),f.updateStatus(a.data.results,!1,!d),f.updatePWG(a.data.results,!1,!d)):(f.inputTags=[],f.updateOnRemoval([],{},{}),f.updateStatus(a.data.results,!0,!0),f.updatePWG(a.data.results,!0,!0)),"all"==b)for(var e=0;e<a.data.results.length;e++)-1===f.inputTags.indexOf(a.data.results[e].member_of_campaign)&&f.inputTags.push(a.data.results[e].member_of_campaign);else f.inputTags.push(b);f.cachedRequestData=a.data.results,f.setURL()}else f.showPopUp("error","No results for this request parameters"),f.setURL(),f.loadingData=!1;d&&d!=f.inputTags.length||(f.updateRequestData(),0==f.loadingData)},function(){f.showPopUp("error","Error getting requests"),f.loadingData=!1})}else f.showPopUp("warning","Your request parameters are empty")},f.modeUpdate=function(a){if(f.growingMode?f.title="Present: Growing Mode":f.title="Present: Announced Mode",f.cachedRequestData=[],f.allRequestData=[],a)return null;var b=angular.copy(f.inputTags);if(b.length<2)for(var c=0;c<b.length;c++)f.load(b[c],!1,!1);else f.inputTags=[],f.updateOnRemoval([],{},{})},f.piecharts={},f.piecharts.compactTerms=["done","to do"],f.piecharts.domain=["new","validation","done","approved","submitted","nothing","defined","to do"],f.piecharts.fullTerms=["new","validation","defined","approved","submitted","done","upcoming"],f.piecharts.nestBy=["member_of_campaign","status"],f.piecharts.sum="total_events",f.priorityPerBlock={1:11e4,2:9e4,3:85e3,4:8e4,5:7e4,6:63e3},f.requests={},f.requests.settings={duration:1e3,legend:!0,sort:!0},f.setURL=function(a,c){b.path(b.path(),!1),void 0!=typeof a&&void 0!=typeof c&&(f.aOptionsValues[f.graphTabs.indexOf(c)]=f.graphParam.indexOf(a));var d={};if(f.inputTags.length&&(d.r=f.inputTags.join(",")),d.p=f.aOptionsValues.join(",")+","+f.aRadioValues.join(","),d.t=f.showDate+"",d.m=f.growingMode+"",d.x=f.filterPriority.join(","),!f.isEmpty(f.allPWG)){var e=[];for(var g in f.allPWG)f.allPWG[g]&&e.push(g);d.w=e.join(",")}if(!f.isEmpty(f.allStatus)){var h=[];for(var g in f.allStatus)f.allStatus[g]&&h.push(g);d.s=h.join(",")}b.search(d),f.url=b.absUrl()},f.setScaleAndOperation=function(a,b){f.aRadioValues[a]!=b&&(f.aRadioValues[a]=b,f.setURL())},f.tagRemove=function(a){f.loadingData=!0,setTimeout(function(){var b=f.cachedRequestData,c=[],d={},e={};if("*"!==a){for(var g=0;g<b.length;g++)b[g].member_of_campaign!==a&&(c.push(b[g]),void 0==e[b[g].status]&&(e[b[g].status]=f.allStatus[b[g].status]),void 0==d[b[g].pwg]&&(d[b[g].pwg]=f.allPWG[b[g].pwg]));f.inputTags.splice(f.inputTags.indexOf(a),1)}f.updateOnRemoval(c,d,e)},1e3)},f.updateOnRemoval=function(a,b,c){f.cachedRequestData=a,f.allPWG=b,f.allStatus=c,f.setURL(),f.updateRequestData()},f.takeScreenshot=function(b){f.loading=!0,void 0===b&&(b="svg");var c=(new XMLSerializer).serializeToString(document.getElementById("ctn").getElementsByTagName("svg")[0]).replace(/#/g,"U+0023");a.get("ts/"+b+"/"+c).then(function(a){window.open(a.data),f.loading=!1})},f.updateUpdate=function(){if(f.growingMode)var b=a.get("api/campaigns,chained_campaigns,requests,chained_requests/lastupdate");else var b=a.get("api/campaigns/lastupdate");b.then(function(a){f.lastUpdate=a.data.results.last_update})},f.updatePWG=function(a,b,c,d){if(b&&(f.allPWG={}),void 0!==d)for(var e=d.split(","),g=0;g<e.length;g++)""!=e[g]&&(f.allPWG[e[g]]=c);for(var g=0;g<a.length;g++){var h=a[g].pwg;void 0===f.allPWG[h]&&(f.allPWG[h]=c)}},f.updateRequestData=function(){f.loadingData=!0;var a=f.filterPriority[1],b=f.filterPriority[0];(isNaN(a)||""==a)&&(a=Number.MAX_VALUE),setTimeout(function(){for(var c=f.cachedRequestData,d=[],e=0;e<c.length;e++)c[e].priority>=b&&c[e].priority<=a&&f.allStatus[c[e].status]&&f.allPWG[c[e].pwg]&&d.push(c[e]);f.$apply(function(){f.allRequestData=d,f.loadingData=!1})},0)},c(f.updateUpdate,12e4),f.updateUpdate(),f.shortenURL=function(){var b=a.get("shorten/"+f.url);b.then(function(a){f.url=a.data})},f.initZeroClipboard=function(){new ZeroClipboard(document.getElementById("copy"),{moviePath:"lib/zeroclipboard/ZeroClipboard.swf"})}}]),pmpApp.controller("IndexController",["$location",function(a){a.search({})}]),pmpApp.controller("TypeaheadCtrl",["$scope","$http",function(a,b){a.suggestions=[],a.getSuggestions=function(c){return""===c?null:void("Present: Announced Mode"===a.title?b.get("api/suggest/"+c+"/announced").then(function(b){a.suggestions=b.data.results}):"Present: Growing Mode"===a.title?b.get("api/suggest/"+c+"/growing").then(function(b){a.suggestions=b.data.results}):"Historical Statistics"===a.title?b.get("api/suggest/"+c+"/historical").then(function(b){a.suggestions=b.data.results}):"Request Performance"===a.title&&b.get("api/suggest/"+c+"/performance").then(function(b){a.suggestions=b.data.results}))}}]),pmpApp.controller("HistoricalController",["$http","$location","$scope","$rootScope","$interval",function(a,b,c,d,e){c.graphType=2,c.allPWG={},c.allRequestData=[],c.allStatus={},c.inputTags=[],c.initHistorical=function(){if(void 0!=b.search().y&&""!=b.search().y?c.zoomOnY="true"==b.search().y:c.zoomOnY=!1,void 0!=b.search().p&&""!=b.search().p?c.probing=b.search().p:c.probing=40,void 0!=b.search().t&&""!=b.search().t?c.showDate="true"==b.search().t:c.showDate=!1,void 0!=b.search().x&&""!=b.search().x){var a=b.search().x.split(",");c.filterPriority={0:a[0],1:a[1]},c.showDate=b.search().t}else c.filterPriority={0:"",1:""};if(void 0!=b.search().w&&""!=b.search().w)for(var a=b.search().w.split(","),d=0;d<a.length;d++)c.allPWG[a[d]]=!0;if(void 0!=b.search().s)for(var a=b.search().s.split(","),d=0;d<a.length;d++)c.allStatus[a[d]]=!0;if(void 0!=b.search().r&&""!=b.search().r){for(var a=b.search().r.split(","),d=0;d<a.length;d++)c.inputTags.push(a[d]);c.query(!0)}c.url=b.absUrl()},c.load=function(a,b){if(a)if(b&-1!==c.inputTags.indexOf(a))c.showPopUp("warning","Your request is already loaded");else{c.allRequestData=[],c.loadingData=!0,b||c.tagsRemoveAll(),c.inputTags.push(a);var d=b;if(d){d=!1;for(var e=0;e<Object.keys(c.allStatus).length;e++)if(!c.allStatus[Object.keys(c.allStatus)[e]]){d=!0;break}if(!d)for(var e=0;e<Object.keys(c.allPWG).length;e++)if(!c.allPWG[Object.keys(c.allPWG)[e]]){d=!0;break}}c.query(d)}else c.showPopUp("warning","Your request parameters are empty")},c.priorityPerBlock={1:11e4,2:9e4,3:85e3,4:8e4,5:7e4,6:63e3},c.query=function(b){if(!c.inputTags.length)return null;c.loadingData=!0;var d="";b&&void 0!=c.filterPriority?(void 0!=c.filterPriority[0]&&(d+=c.filterPriority[0]),d+=",",void 0!=c.filterPriority[1]&&(d+=c.filterPriority[1])):d=",";var e="";if(b&&Object.keys(c.allStatus).length){for(var f=0;f<Object.keys(c.allStatus).length;f++)c.allStatus[Object.keys(c.allStatus)[f]]&&(e+=Object.keys(c.allStatus)[f]+",");e=e.length>1?e.substr(0,e.length-1):"_"}else e="all";var g="";if(b&&Object.keys(c.allPWG).length){for(var f=0;f<Object.keys(c.allPWG).length;f++)c.allPWG[Object.keys(c.allPWG)[f]]&&(g+=Object.keys(c.allPWG)[f]+",");g=g.length>1?g.substr(0,g.length-1):"_"}else g="all";var h=40;""!=c.probing&&(h=c.probing);var i=a.get("api/"+c.inputTags.join(",")+"/historical/"+h+"/"+d+"/"+e+"/"+g);i.then(function(a){a.data.results.status?(a.data.results.data.length||c.showPopUp("warning","All data is filtered"),c.allRequestData=a.data.results.data,c.allStatus=a.data.results.status,c.allPWG=a.data.results.pwg,c.loadTaskChain=a.data.results.taskchain):c.showPopUp("error","No results for this request parameters"),c.loadingData=!1,c.setURL()},function(){c.showPopUp("error","Error getting requests"),c.loadingData=!1}),a.get("api/"+c.inputTags.join(",")+"/submitted/"+d+"/"+g).then(function(a){a.data.results?c.listSubmitted=a.data.results:c.listSubmitted={}},function(){c.showPopUp("error","Error getting requests")})},c.setURL=function(){b.path(b.path(),!1);var a={};a.p=c.probing,c.inputTags.length&&(a.r=c.inputTags.join(",")),a.t=c.showDate+"",(""!=c.filterPriority[0]||""!=c.filterPriority[1])&&(a.x=c.filterPriority[0]+","+c.filterPriority[1]);var d=[];for(var e in c.allPWG)c.allPWG[e]&&d.push(e);a.w=d.join(",");var f=[];for(var e in c.allStatus)c.allStatus[e]&&f.push(e);a.s=f.join(","),void 0!=c.zoomOnY?a.y=c.zoomOnY+"":a.y="false",b.search(a),c.url=b.absUrl()},c.tagRemove=function(a){c.inputTags.splice(c.inputTags.indexOf(a),1),c.inputTags.length?c.query(!0):c.tagsRemoveAll()},c.tagsRemoveAll=function(){c.inputTags=[],c.allRequestData=[],c.allStatus={},c.allPWG={},c.setURL()},c.takeScreenshot=function(b){c.loading=!0,void 0===b&&(b="svg");var d=(new XMLSerializer).serializeToString(document.getElementById("ctn").getElementsByTagName("svg")[0]).replace(/#/g,"U+0023");a.get("ts/"+b+"/"+d).then(function(a){window.open(a.data),c.loading=!1})},c.title="Historical Statistics",c.updateRequestData=function(){c.query(!0)},c.updateUpdate=function(){var b=a.get("api/stats/lastupdate");b.then(function(a){c.lastUpdate=a.data.results.last_update})},e(c.updateUpdate,12e4),c.updateUpdate(),c.shortenURL=function(){var b=a.get("shorten/"+c.url);b.then(function(a){c.url=a.data})},c.initZeroClipboard=function(){new ZeroClipboard(document.getElementById("copy"),{moviePath:"lib/zeroclipboard/ZeroClipboard.swf"})}}]),pmpApp.controller("PerformanceController",["$http","$interval","$location","$scope",function(a,b,c,d){d.graphType=3,d.cachedRequestData=[],d.allRequestData=[],d.inputTags=[],d.filterPriority=["",""],d.load=function(b,c,e){if(b)if(c&-1!==d.inputTags.indexOf(b))d.showPopUp("warning","Your request is already loaded");else{d.loadingData=!0;var f=a.get("api/"+b+"/performance");f.then(function(a){if(a.data.results.length){if(d.allRequestData=[],c?a.data.results.push.apply(a.data.results,d.cachedRequestData):(d.inputTags=[],d.updateOnRemoval([],{},{})),d.cachedRequestData=a.data.results,"all"==b)for(var f=0;f<a.data.results.length;f++)-1===d.inputTags.indexOf(a.data.results[f].member_of_campaign)&&d.inputTags.push(a.data.results[f].member_of_campaign);else d.inputTags.push(b);d.update(a.data.results,!e,"pwg","allPWG"),d.update(a.data.results,!e,"status","allStatus")}else d.showPopUp("error","No results for this request parameters"),d.loadingData=!1;e&&e!=d.inputTags.length||(d.updateRequestData(),d.setURL(),0==d.loadingData)},function(){d.showPopUp("error","Error getting requests"),d.loadingData=!1})}else d.showPopUp("warning","Your request parameters are empty")},d.tagRemove=function(a){d.loadingData=!0,setTimeout(function(){var b=d.cachedRequestData,c=[],e={},f={};if("*"!==a){for(var g=0;g<b.length;g++)b[g].member_of_campaign!==a&&(c.push(b[g]),void 0==f[b[g].status]&&(f[b[g].status]=d.allStatus[b[g].status]),void 0==e[b[g].pwg]&&(e[b[g].pwg]=d.allPWG[b[g].pwg]));d.inputTags.splice(d.inputTags.indexOf(a),1)}d.updateOnRemoval(c,e,f)},1e3)},d.updateOnRemoval=function(a,b,c){d.cachedRequestData=data,d.allPWG=b,d.allStatus=c,d.allRequestData=data,d.loadingData=!1},d.update=function(a,b,c,e){for(var f=d[e],g=0;g<a.length;g++)void 0==f[a[g][c]]&&(f[a[g][c]]=b);d[e]=f},d.allPWG={},d.allStatus={},d.title="Request Performance",d.applyHistogram=function(a,b){d.histogramData=a,d.histogramDataExtended=b},d.applyDifference=function(a){d.difference=a,d.setURL()},d.changeScale=function(a){d.linearScale=a,d.setURL()},d.priorityPerBlock={1:11e4,2:9e4,3:85e3,4:8e4,5:7e4,6:63e3},d.updateRequestData=function(){d.loadingData=!0;var a=d.filterPriority[1],b=d.filterPriority[0];(isNaN(a)||""==a)&&(a=Number.MAX_VALUE),(isNaN(b)||""==b)&&(b=0);for(var c=d.cachedRequestData,e=[],f=0;f<c.length;f++)c[f].priority>=b&&c[f].priority<=a&&d.allStatus[c[f].status]&&d.allPWG[c[f].pwg]&&e.push(c[f]);d.allRequestData=e,d.loadingData=!1},d.updateUpdate=function(){var b=a.get("api/requests/lastupdate");b.then(function(a){d.lastUpdate=a.data.results.last_update})},b(d.updateUpdate,12e4),d.updateUpdate(),d.takeScreenshot=function(){var a=document.getElementById("ctn"),b=a.getElementsByTagName("svg")[0],c=(new XMLSerializer).serializeToString(b),d=new Blob([c],{type:"text/plain;charset=utf-8"});saveAs(d,"screenshot.html")},d.setURL=function(){c.path(c.path(),!1);var a={};if((void 0!=d.bins||""!=d.bins)&&(a.b=d.bins),d.inputTags.length&&(a.r=d.inputTags.join(",")),void 0!=d.showDate&&(a.t=d.showDate+""),(""!=d.filterPriority[1]||""!=d.filterPriority[0])&&(a.x=d.filterPriority.join(",")),!d.isEmpty(d.allPWG)){var b=[];for(var e in d.allPWG)d.allPWG[e]&&b.push(e);a.w=b.join(",")}var f=[];for(var e in d.allStatus)d.allStatus[e]&&f.push(e);a.s=f.join(","),""!=d.difference.minuend&&(a.min=d.difference.minuend),""!=d.difference.subtrahend&&(a.sub=d.difference.subtrahend),void 0!=d.linearScale&&(a.l=d.linearScale+""),c.search(a),d.url=c.absUrl()},d.shortenURL=function(){var b=a.get("shorten/"+d.url);b.then(function(a){d.url=a.data})},d.initZeroClipboard=function(){new ZeroClipboard(document.getElementById("copy"),{moviePath:"lib/zeroclipboard/ZeroClipboard.swf"})},d.initPerformance=function(){if(d.difference={minuend:"",subtrahend:""},d.selections=["created","validation","approved","submitted","done"],void 0!=c.search().min){var a=d.selections.indexOf(c.search().min);-1!=a&&(d.difference.minuend=c.search().min,d.selections.splice(a,1))}if(void 0!=c.search().sub){var a=d.selections.indexOf(c.search().sub);-1!=a&&(d.difference.subtrahend=c.search().sub,d.selections.splice(a,1))}if(d.showDate="true"===c.search().t,d.linearScale="true"===c.search().l,""==c.search.b||isNaN(c.search().b)?d.bins=10:d.bins=parseInt(c.search().b,10),d.filterPriority=["",""],void 0!=c.search().x){var b=c.search().x.split(",");d.filterPriority=b}if(d.allPWG={},void 0!=c.search().w)for(var b=c.search().w.split(","),e=0;e<b.length;e++)""!=b[e]&&(d.allPWG[b[e]]=!0);if(d.allStatus={},void 0!=c.search().s)for(var b=c.search().s.split(","),e=0;e<b.length;e++)""!=b[e]&&(d.allStatus[b[e]]=!0);if(void 0!=c.search().r){d.loadingData=!0;var b=c.search().r.split(","),f=!1;if(Object.keys(d.allPWG).length)var f=b.length;for(var e=0;e<b.length;e++)d.load(b[e],!0,f)}else d.url=c.absUrl()}}]),pmpApp.controller("ChainsController",["$http","$scope",function(a,b){b.parseResponse=function(a){for(var b=[],c=[],d=[],e=0;e<a.length;e++)for(var f=0;f<a[e].campaigns.length;f++)-1===$.inArray(a[e].campaigns[f][0],b)&&(b.push(a[e].campaigns[f][0]),c.push({id:a[e].campaigns[f][0]})),0!==f&&d.push({source:a[e].campaigns[f-1][0],target:a[e].campaigns[f][0],name:a[e].campaigns[f][1]});return{nodes:c,links:d}},b.setListeners=function(){var a=$("svg");a.on("mouseover",".node",function(){$(this).find(".node-text").show()}).on("mouseleave",".node",function(){$(this).find(".node-text").hide()})},b.initChains=function(){b.title="Chains Landscape",b.allRequestData=[],b.loadingData=!0;var c=a.get("api/_/chain");c.then(function(a){b.allRequestData=b.parseResponse(a.data.results),b.setListeners(),b.loadingData=!1})}}]);